<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CMH8 TOOL - Professional Email Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand: #6366f1; --brand-darker: #4f46e5; --brand-glow: rgba(99, 102, 241, 0.3);
      --ok: #10b981; --ok-darker: #059669; --ok-glow: rgba(16, 185, 129, 0.3);
      --warn: #f59e0b; --warn-darker: #d97706; --warn-glow: rgba(245, 158, 11, 0.3);
      --info: #06b6d4; --info-darker: #0891b2; --info-glow: rgba(6, 182, 212, 0.3);
      --danger: #ef4444; --danger-darker: #dc2626; --danger-glow: rgba(239, 68, 68, 0.3);
      --primary: #3b82f6; --primary-darker: #2563eb; --primary-glow: rgba(59, 130, 246, 0.3);
      --history: #8b5cf6; --history-darker: #7c3aed; --history-glow: rgba(139, 92, 246, 0.3);

      --bg1: #f8fafc; --bg2: #f1f5f9; --text: #1e293b; --muted: #64748b; --border: #e2e8f0;
      --panel: #ffffff; --shadow: rgba(0, 0, 0, 0.08); --shadow-hover: rgba(0, 0, 0, 0.12);

      --dark-bg1: #0f172a; --dark-bg2: #1e293b; --dark-text: #f1f5f9; --dark-muted: #94a3b8;
      --dark-border: rgba(255, 255, 255, 0.1); --dark-shadow: rgba(0, 0, 0, 0.3);
      --dark-panel-bg: rgba(30, 41, 59, 0.7); --dark-component-bg: rgba(15, 23, 42, 0.5);

      --radius-sm: 6px; --radius-md: 10px; --radius-lg: 14px; --radius-xl: 18px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text);
      transition: var(--transition-slow);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* Enhanced star animation */
    @keyframes animateStars {
      from { transform: translateY(0px); }
      to { transform: translateY(-2000px); }
    }

    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }

    .stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2000px;
      background-repeat: repeat;
      background-position: center;
      animation-name: animateStars;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    #stars1 {
      background-size: 200px 200px;
      animation-duration: 120s;
      background-image:
        radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 90px 40px, #ddd, rgba(0,0,0,0));
    }

    #stars2 {
      background-size: 300px 300px;
      animation-duration: 100s;
      background-image:
        radial-gradient(1px 1px at 150px 120px, #ddd, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 10px 90px, #eee, rgba(0,0,0,0));
    }

    #stars3 {
      background-size: 400px 400px;
      animation-duration: 80s;
      background-image:
        radial-gradient(1px 1px at 180px 140px, #ddd, rgba(0,0,0,0));
    }

    /* Premium animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes pulseGlow {
      0% { box-shadow: 0 0 0 0 var(--brand-glow); }
      70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
      100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* Main container with premium styling */
    .main-container {
      max-width: 1600px;
      margin: 30px auto;
      background: var(--panel);
      border-radius: var(--radius-xl);
      padding: 30px;
      transition: var(--transition-slow);
      animation: fadeInUp 0.6s ease-out forwards;
      border: 1px solid transparent;
      box-shadow:
        0 10px 40px var(--shadow),
        0 0 0 1px rgba(0, 0, 0, 0.02);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .main-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand), var(--ok), var(--warn), var(--info));
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }

    .content-wrapper {
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Enhanced typography */
    h2 {
      text-align: center;
      color: var(--brand);
      margin: 0 0 25px;
      transition: var(--transition);
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: -0.025em;
      background: linear-gradient(135deg, var(--brand) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, var(--brand), var(--primary));
      border-radius: 2px;
    }

    h3 {
      color: var(--text);
      margin: 28px 0 15px;
      transition: var(--transition);
      font-weight: 600;
      font-size: 1.25rem;
      position: relative;
      padding-left: 12px;
    }

    h3::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 18px;
      background: var(--brand);
      border-radius: 2px;
    }

    label {
      font-weight: 600;
      color: var(--text);
      transition: var(--transition);
      font-size: 0.9rem;
      display: block;
      margin-bottom: 6px;
    }

    /* Premium form elements */
    textarea, input[type=text] {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      background: var(--bg1);
      resize: vertical;
      box-shadow: inset 0 2px 4px var(--shadow);
      transition: var(--transition);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    }

    textarea:focus, input[type=text]:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow:
        inset 0 2px 4px var(--shadow),
        0 0 0 3px var(--brand-glow);
      transform: translateY(-1px);
    }

    textarea {
      min-height: 200px;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    input[type=text] {
      max-width: 420px;
      margin: 6px 0 12px;
    }

    /* Premium buttons */
    .buttons {
      margin-top: 22px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn {
      padding: 14px 26px;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.025em;
      text-transform: none;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px var(--shadow-hover);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* Button variants with gradient backgrounds */
    .import-btn { background: linear-gradient(135deg, var(--brand), var(--brand-darker)); }
    .clean-btn { background: linear-gradient(135deg, var(--ok), var(--ok-darker)); }
    .export-btn { background: linear-gradient(135deg, var(--warn), var(--warn-darker)); }
    .clear-btn { background: linear-gradient(135deg, var(--info), var(--info-darker)); }
    .deselect-btn { background: linear-gradient(135deg, var(--danger), var(--danger-darker)); }
    .apply-btn { background: linear-gradient(135deg, var(--primary), var(--primary-darker)); }
    .insert-btn { background: linear-gradient(135deg, #ff5722, #e64a19); }
    .subject-btn { background: linear-gradient(135deg, #9c27b0, #7b1fa2); }
    .custom-name-btn { background: linear-gradient(135deg, #ff9800, #f57c00); }
    .encode-btn { background: linear-gradient(135deg, #2196f3, #1976d2); }
    .decode-btn { background: linear-gradient(135deg, #4caf50, #388e3c); }
    .copy-btn { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .history-btn { background: linear-gradient(135deg, var(--history), var(--history-darker)); }
    .clear-btn.extraction-clear { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .info-btn { background: linear-gradient(135deg, var(--info), var(--info-darker)); }


    /* Enhanced tabs */
    .tabs {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border);
      transition: border-color 0.5s;
      position: relative;
    }

    .tab {
      padding: 14px 28px;
      cursor: pointer;
      background: transparent;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      margin-right: 4px;
      font-weight: 600;
      transition: var(--transition);
      color: var(--muted);
      position: relative;
      border: 0;
      font-size: 0.95rem;
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand), var(--primary));
      border-radius: 2px;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tab:hover {
      color: var(--text);
      background: rgba(99, 102, 241, 0.05);
    }

    .tab.active {
      color: var(--brand);
      font-weight: 700;
    }

    .tab.active::after {
      width: 80%;
    }

    /* Enhanced tab content */
    .tab-content {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Premium headers box */
    .headers-box {
      margin: 15px 0 0;
      padding: 16px;
      border-radius: var(--radius-lg);
      background: var(--bg1);
      border: 1.5px solid var(--border);
      max-height: 220px;
      overflow: auto;
      transition: var(--transition);
      box-shadow: inset 0 2px 6px var(--shadow);
    }

    /* Enhanced toggle buttons */
    .dark-mode-toggle {
      position: fixed;
      top: 25px;
      right: 25px;
      z-index: 1000;
      width: 62px;
      height: 32px;
      border-radius: 20px;
      cursor: pointer;
      transition: var(--transition);
      background: var(--muted);
      border: 2px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
      animation: float 3s ease-in-out infinite;
    }

    .dark-mode-toggle::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .dark-mode-toggle.active {
      background: var(--brand);
      border-color: var(--brand);
    }

    .dark-mode-toggle.active::before {
      transform: translateX(30px);
    }

    .history-toggle {
      position: fixed;
      top: 25px;
      right: 100px;
      z-index: 1000;
      animation: float 3s ease-in-out infinite 0.2s;
    }

    /* Enhanced history panel */
    .history-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      padding: 25px;
      overflow-y: auto;
      transform: translateX(100%);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-slow);
      backdrop-filter: blur(8px);
    }

    .history-panel.active {
      transform: translateX(0);
      opacity: 1;
      visibility: visible;
    }

    /* Dark mode enhancements */
    body.dark-mode {
      background: linear-gradient(135deg, var(--dark-bg1) 0%, var(--dark-bg2) 100%);
      color: var(--dark-text);
    }

    body.dark-mode #stars-container {
      opacity: 1;
    }

    body.dark-mode .main-container {
      background: var(--dark-panel-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--dark-border);
      box-shadow:
        0 20px 60px var(--dark-shadow),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    body.dark-mode textarea,
    body.dark-mode input[type=text],
    body.dark-mode .headers-box,
    body.dark-mode .always-box,
    body.dark-mode .preview-wrap {
      background: var(--dark-component-bg);
      border: 1.5px solid var(--dark-border);
      color: var(--dark-text);
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.2);
    }

    body.dark-mode textarea:focus,
    body.dark-mode input[type=text]:focus {
      border-color: var(--brand);
      box-shadow:
        inset 0 2px 6px rgba(0,0,0,0.3),
        0 0 0 3px var(--brand-glow);
    }

    body.dark-mode .dark-mode-toggle,
    body.dark-mode .history-toggle {
      background: rgba(30, 41, 59, 0.8);
      border-color: var(--dark-border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    body.dark-mode h3,
    body.dark-mode label {
      color: var(--dark-text);
    }

    body.dark-mode .tabs {
      border-color: var(--dark-border);
    }

    body.dark-mode .tab {
      color: var(--dark-muted);
    }

    body.dark-mode .tab:hover {
      color: var(--dark-text);
      background: rgba(99, 102, 241, 0.1);
    }

    body.dark-mode .tab.active {
      color: #fff;
    }

    /* Enhanced layout components */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    .left-panel {
      grid-column: 1;
    }

    .right-panel {
      grid-column: 2;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .preview-section {
      grid-column: 2;
      grid-row: 1;
    }

    .output-section {
      grid-column: 2;
      grid-row: 2;
    }

    .insert-section {
      grid-column: 2;
      grid-row: 3;
    }

    /* Enhanced preview section */
    .preview-wrap {
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 4px 20px var(--shadow);
      transition: var(--transition);
    }

    .preview-wrap:hover {
      box-shadow: 0 8px 30px var(--shadow-hover);
    }

    /* Responsive improvements */
    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      .preview-section, .output-section, .insert-section {
        grid-column: 1;
      }
      .preview-section { grid-row: 2; }
      .output-section { grid-row: 3; }
      .insert-section { grid-row: 4; }
    }

    @media (max-width: 768px) {
      .main-container {
        margin: 15px;
        padding: 20px;
        border-radius: var(--radius-lg);
      }

      .buttons {
        justify-content: center;
      }

      .btn {
        flex: 1;
        min-width: 140px;
      }

      .dark-mode-toggle {
        top: 15px;
        right: 15px;
      }

      .history-toggle {
        top: 15px;
        right: 85px;
      }
    }

    /* Enhanced status indicators */
    .action-status {
      font-size: 12px;
      color: var(--ok);
      margin-top: 6px;
      display: none;
      padding: 4px 8px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--ok);
    }

    .action-status.error {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
      border-left-color: var(--danger);
    }

    /* Enhanced extraction section */
    .extraction-options {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 25px 0;
      background: var(--bg1);
      padding: 20px;
      border-radius: var(--radius-lg);
      border: 1.5px solid var(--border);
      transition: var(--transition);
    }

    .option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: white;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .option:hover {
      border-color: var(--brand);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .option input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .option label {
      cursor: pointer;
      font-weight: 500;
      margin: 0;
    }

    /* Enhanced info boxes */
    .auto-extract-info,
    .server-pattern-info,
    .ip-association-info {
      padding: 16px 20px;
      border-radius: var(--radius-lg);
      margin-top: 15px;
      font-size: 0.9rem;
      border-left: 4px solid;
      transition: var(--transition);
    }

    .auto-extract-info {
      background: rgba(6, 182, 212, 0.1);
      color: #0e7490;
      border-left-color: var(--info);
    }

    .server-pattern-info {
      background: rgba(245, 158, 11, 0.1);
      color: #92400e;
      border-left-color: var(--warn);
    }

    .ip-association-info {
      background: rgba(139, 92, 246, 0.1);
      color: #5b21b6;
      border-left-color: var(--history);
    }

    /* Enhanced output box */
    .output-box {
      background: var(--bg1);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      min-height: 150px;
      white-space: pre-wrap;
      font-family: 'SF Mono', monospace;
      overflow-y: auto;
      max-height: 300px;
      transition: var(--transition);
      box-shadow: inset 0 2px 6px var(--shadow);
    }

    /* Loading animation for buttons */
    .btn.loading {
      pointer-events: none;
      opacity: 0.8;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: button-loading-spinner 1s ease infinite;
    }

    @keyframes button-loading-spinner {
      from { transform: rotate(0turn); }
      to { transform: rotate(1turn); }
    }

    /* Flex layout for encoder/decoder */
    .flex-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .col {
      display: flex;
      flex-direction: column;
    }

    .encoding-options {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 15px 0;
    }

    .encoding-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: normal;
      padding: 8px 12px;
      background: var(--bg1);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .encoding-options label:hover {
      border-color: var(--brand);
    }

    /* Viewer styles */
    .viewer-bar {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .viewer-toggles {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toggle {
      display: flex;
      background: var(--bg1);
      border-radius: var(--radius-md);
      padding: 4px;
      border: 1px solid var(--border);
    }

    .toggle button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .toggle button.active {
      background: var(--brand);
      color: white;
    }

    .chip {
      background: var(--ok);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .live-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    /* Code view styles */
    .code-view {
      margin: 0;
      padding: 20px;
      height: 480px;
      overflow: auto;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 12px;
      line-height: 1.4;
      border-radius: var(--radius-lg);
      font-family: 'SF Mono', Monaco, Consolas, monospace;
    }

    .code-view code {
      counter-reset: ln;
    }

    .code-view code span {
      display: block;
      white-space: pre;
      font-family: inherit;
    }

    .code-view code span:before {
      counter-increment: ln;
      content: counter(ln);
      display: inline-block;
      width: 2.5em;
      margin-right: 1em;
      color: #64748b;
    }

    /* History styles */
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }

    .history-categories {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .history-category {
      padding: 10px 20px;
      background: var(--bg1);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border);
      font-weight: 500;
    }

    .history-category.active {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
    }

    .history-items-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .history-item {
      background: var(--bg1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: var(--transition);
      cursor: pointer;
    }

    .history-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--shadow);
      border-color: var(--brand);
    }

    .history-title {
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--brand);
      font-size: 0.95rem;
    }

    .history-content {
      font-size: 0.85rem;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .history-timestamp {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
    }

    .no-history {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
      font-style: italic;
      grid-column: 1 / -1;
    }

    .clear-history {
      display: block;
      text-align: center;
      margin-top: 30px;
      color: var(--danger);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 12px;
      border-radius: var(--radius-md);
      transition: var(--transition);
    }

    .clear-history:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Always box styles */
    .always-box {
      margin: 15px 0;
    }

    .always-inner {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .filename-input {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .filename-input input {
      flex: 1;
      max-width: 300px;
      margin: 0;
    }

    /* Gmail preview styles */
    .gmail-chrome {
      background: var(--bg1);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .gmail-body {
      height: 400px;
    }

    .gmail-body iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Checkbox group styles */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
    }

    .checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Header checkbox styles */
    .header-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 4px 0;
    }

    .header-checkbox.fixed-selected {
      background: rgba(16, 185, 129, 0.1);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--ok);
    }

    .header-checkbox.fixed-selected label {
      font-weight: 700;
      color: var(--ok-darker);
    }

    .header-checkbox.optional {
      background: rgba(59, 130, 246, 0.05);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--primary);
    }

    .header-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .header-checkbox input[type="checkbox"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="stars-container">
    <div id="stars1" class="stars"></div>
    <div id="stars2" class="stars"></div>
    <div id="stars3" class="stars"></div>
  </div>

  <div class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode"></div>
  <button class="history-toggle btn history-btn" id="historyToggle">
    <span>📜 History</span>
  </button>

  <div class="history-panel" id="historyPanel">
    <div class="history-header">
      <h2>Activity History</h2>
      <button class="close-history btn danger-btn" id="closeHistory">Close</button>
    </div>
    <div class="history-categories" id="historyCategories">
      <div class="history-category active" data-category="all">All Activities</div>
      <div class="history-category" data-category="cleaned">Cleaned Content</div>
      <div class="history-category" data-category="htmlInsert">HTML Inserted</div>
      <div class="history-category" data-category="export">Exported Files</div>
      <div class="history-category" data-category="subject">Subject Changes</div>
    </div>
    <div class="history-items-container" id="historyItems"></div>
    <div class="clear-history" id="clearHistory">Clear All History</div>
  </div>

  <div class="main-container">
    <div class="content-wrapper">
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px;text-align:center;font-weight:500;letter-spacing:0.05em;">
        YOUSSEF DERRAZ CMH8 • PROFESSIONAL EMAIL SUITE
      </div>
      <h2>NEWSLETTER Cleaner</h2>

      <div class="tabs">
        <button class="tab active" data-tab="email-cleaner">📧 Email Cleaner</button>
        <button class="tab" data-tab="encoder-decoder">🔐 Encoder/Decoder</button>
        <button class="tab" data-tab="extraction">🔍 Extraction Tool</button>
      </div>

      <div class="tab-content active show" id="email-cleaner">
        <div class="main-layout">
          <div class="left-panel">
            <label for="input">Paste NEWSLETTER:</label>
            <p style="font-size: 13px; color: var(--muted); margin: -5px 0 10px 0;">
              <b>For batch processing:</b> Separate each email with a new line containing exactly: <code>---END-OF-EMAIL---</code>
            </p>
            <textarea id="input" placeholder="Paste header here..."></textarea>
            <input id="fileInput" type="file" accept=".txt,.eml,text/*" style="display:none" multiple/>
            <div class="buttons">
              <button class="btn import-btn" id="importBtn">📁 Import</button>
              <button class="btn clean-btn" id="cleanBtn">✨ Clean</button>
              <button class="btn export-btn" id="exportBtn">💾 Export</button>
              <button class="btn clear-btn" id="clearBtn">🗑️ Clear</button>
              <button class="btn deselect-btn" id="deselectBtn">❌ Deselect Optional</button>
            </div>
            <div class="filename-input">
              <label for="exportFilename">Export filename (Base):</label>
              <input type="text" id="exportFilename" placeholder="Enter base filename..." value="cleaned_email" />
              <div style="font-size:12px; color:var(--muted); flex-basis: 100%;">
                Each email will be saved as: e.g., "cleaned_email_1.txt", "cleaned_email_2.txt"
              </div>
            </div>
            <h3>Choose PARAMS to remove:</h3>
            <div class="always-box">
              <label><b>Fixed params (always removed) 🔒</b></label>
              <div style="font-size:12px; color:var(--muted); margin:5px 0 10px 0;">
                These params are always selected and cannot be changed
              </div>
            </div>
            <div id="headersBox" class="headers-box">
              <p style="color:var(--muted)"> Paste or Import a header to see available fields...</p>
            </div>
            <div class="options">
              <label>Custom From Name:</label>
              <input type="text" id="customName" placeholder="FROM NAME (leave empty to keep original)" value="" />
              <button class="btn custom-name-btn" id="applyCustomNameBtn">👤 Apply From Name</button>
              <div id="fromNameStatus" class="action-status">Already applied</div>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="toggleRdns"/>
                  <label for="toggleRdns">ADD [RDNS]</label>
                  <div id="rdnsStatus" class="action-status">Already applied</div>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="toggleRpath"/>
                  <label for="toggleRpath">ADD [P_RPATH]</label>
                  <div id="rpathStatus" class="action-status">Already applied</div>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="toggleEid"/>
                  <label for="toggleEid">Add [eid]</label>
                  <div id="eidStatus" class="action-status">Already applied</div>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="toggleIp"/>
                  <label for="toggleIp">ADD [ip]</label>
                  <div id="ipStatus" class="action-status">Already applied</div>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="toggleHead"/>
                  <label for="toggleHead">Add &lt;head&gt;&lt;select&gt; hide news content</label>
                  <div id="headStatus" class="action-status">Already applied</div>
                </div>
              </div>
              <button class="btn apply-btn" id="applyBtn"> Apply Transformations</button>
            </div>
            <div class="options">
              <label>Custom Subject:</label>
              <input type="text" id="customSubject" placeholder="Enter custom subject..." />
              <button class="btn subject-btn" id="subjectBtn"> Apply Subject</button>
              <div id="subjectStatus" class="action-status">Already applied</div>
            </div>
          </div>
          <div class="right-panel">
            <div class="preview-section">
              <div class="viewer-bar">
                <div class="viewer-toggles">
                  <div class="toggle" role="tablist" aria-label="Viewer mode">
                    <button id="btnGmail" class="active" role="tab" aria-selected="true">📨 Gmail View</button>
                    <button id="btnSource" role="tab" aria-selected="false">&lt;/&gt; Source View</button>
                  </div>
                  <span class="chip">Live</span>
                </div>
                <label class="live-check"><input type="checkbox" id="liveToggle" checked /> Update while typing</label>
              </div>
              <div class="preview-wrap">
                <div id="gmailPreview" style="display:block">
                  <div class="gmail-chrome">
                    <span class="chip">Inbox</span>
                    <span style="font-weight:600">Preview</span>
                    <span style="margin-left:auto; font-size:12px; color:var(--muted)">(Mock Gmail UI)</span>
                  </div>
                  <div class="gmail-body">
                    <iframe id="gmailFrame" title="Gmail-like preview"></iframe>
                  </div>
                </div>
                <pre id="sourceView" class="code-view" style="display:none"><code id="codeBlock"></code></pre>
              </div>
            </div>
            <div class="output-section">
              <h3>Cleaned STR:</h3>
              <textarea id="output" placeholder="Result will appear here..."></textarea>
            </div>
            <div class="insert-section">
              <div class="options">
                <label>Insert HTML:</label>
                <textarea id="insertText" placeholder="Enter text to insert above &lt;head&gt;&lt;select&gt;..."></textarea><br/>
                <button class="btn insert-btn" id="insertBtn">📄 Insert HTML</button>
                <div id="insertStatus" class="action-status">Already applied</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="encoder-decoder">
        <div class="flex-2col">
          <div class="col">
            <h3>Encode/Decode Text</h3>
            <label for="encodeInput">Input Text:</label>
            <textarea id="encodeInput" placeholder="Enter text to encode or decode..."></textarea>
            <div class="encoding-options">
              <label><input type="radio" name="encodingType" value="base64" checked> Base64</label>
              <label><input type="radio" name="encodingType" value="url"> URL Encoding</label>
              <label><input type="radio" name="encodingType" value="html"> HTML Entities</label>
              <label><input type="radio" name="encodingType" value="hex"> Hex</label>
              <label><input type="radio" name="encodingType" value="quoted-printable"> Quoted-Printable</label>
            </div>
            <div class="buttons">
              <button class="btn encode-btn" id="encodeBtn">Encode</button>
              <button class="btn decode-btn" id="decodeBtn">Decode</button>
              <button class="btn clear-btn" id="clearEncodeBtn">Clear</button>
            </div>
            <h3>Result:</h3>
            <textarea id="encodeOutput" placeholder="Result will appear here..."></textarea>
          </div>
          <div class="col">
            <h3>About Encoding Types</h3>
            <div class="headers-box">
              <p><strong>Base64 Encoding:</strong> Converts binary data into ASCII characters. Commonly used for email attachments and data URLs.</p>
              <p><strong>URL Encoding:</strong> Replaces unsafe ASCII characters with a "%" followed by two hexadecimal digits.</p>
              <p><strong>HTML Entities:</strong> Replaces reserved HTML characters with entity names or numbers to prevent parsing issues.</p>
              <p><strong>Hex Encoding:</strong> Represents data with hexadecimal values (0-9, A-F).</p>
              <p><strong>Quoted-Printable:</strong> Encodes 8-bit characters into 7-bit ASCII. Used for MIME email messages.</p>
            </div>
            <h3>Quick Actions</h3>
            <div class="buttons">
              <button class="btn copy-btn" id="copyEncodeBtn">Copy Result</button>
              <button class="btn export-btn" id="swapEncodeBtn">Swap Input/Output</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="extraction">
        <div class="input-section">
          <h3>Input Text</h3>
          <textarea id="inputText" placeholder="Paste your email snippets here, separated by a blank line...">Call of Duty
Complete your Call of Duty registration - 173.232.171.36
VERIFY EMAIL NOW

Example Company
Another Subject Line
Here is another IP: 192.168.1.1</textarea>
          <div class="extraction-options">
            <div class="option">
              <input type="checkbox" id="associateIPs">
              <label for="associateIPs">Associate IPs with Sender/Subject</label>
            </div>
            <div class="option">
              <input type="checkbox" id="extractIPs" checked>
              <label for="extractIPs">Extract IP Addresses (Simple)</label>
            </div>
            <div class="option">
              <input type="checkbox" id="extractServers" checked>
              <label for="extractServers">Extract Server Names (Simple)</label>
            </div>
            <div class="option">
              <input type="checkbox" id="extractDomains" checked>
              <label for="extractDomains">Extract Domains (Simple)</label>
            </div>
          </div>
          <div id="associationFilterContainer" style="display: none; margin-top: 15px;">
            <label for="associationFilter">Filter by Sender or Subject:</label>
            <input type="text" id="associationFilter" placeholder="Enter keyword to filter results..." style="max-width: 100%; margin-top: 6px;">
          </div>
          <div class="ip-association-info">
            <strong>IP Association Format:</strong> For best results, paste each email snippet separated by a blank line, with the Sender on the first line and the Subject on the second.
          </div>
          <div class="auto-extract-info">
            <strong>Auto-Extract Enabled:</strong> Results update automatically as you type or change options.
          </div>
          <div class="buttons">
            <button class="copy-btn btn" id="copyExtractionBtn">Copy Results</button>
            <button class="clear-btn extraction-clear btn" id="clearExtractionBtn">Clear Text</button>
          </div>
        </div>
        <div class="output-section">
          <h3>Extracted Results</h3>
          <div class="output-box" id="extractionOutputText"></div>
          <p class="results-info" id="resultsInfo">No results yet. Start typing or paste text to see extracted items.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const EMAIL_DELIMITER = '---END-OF-EMAIL---';

    // Fixed always-selected params (locked - user cannot change these)
    const FIXED_SELECTED_PARAMS = [
      'ARC-Authentication-Results',
      'ARC-Message-Signature',
      'ARC-Seal',
      'Authentication-Results',
      'DKIM-Signature',
      'Delivered-To',
      'Received-SPF',
      'Return-Path',
      'X-Entity-ID',
      'X-FA-Origin',
      'X-Google-Smtp-Source',
      'X-Received',
      'X-SG-EID',
      'sender'
    ];

    // DOM Elements
    const input = document.getElementById('input');
    const output = document.getElementById('output');
    const fileInput = document.getElementById('fileInput');
    const importBtn = document.getElementById('importBtn');
    const cleanBtn = document.getElementById('cleanBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const deselectBtn = document.getElementById('deselectBtn');
    const applyBtn = document.getElementById('applyBtn');
    const headersBox = document.getElementById('headersBox');
    const exportFilenameInput = document.getElementById('exportFilename');
    const customNameInput = document.getElementById('customName');
    const applyCustomNameBtn = document.getElementById('applyCustomNameBtn');
    const insertTextarea = document.getElementById('insertText');
    const insertBtn = document.getElementById('insertBtn');
    const customSubjectInput = document.getElementById('customSubject');
    const subjectBtn = document.getElementById('subjectBtn');
    const liveToggle = document.getElementById('liveToggle');
    const gmailFrame = document.getElementById('gmailFrame');
    const sourceView = document.getElementById('sourceView');
    const gmailPreview = document.getElementById('gmailPreview');
    const codeBlock = document.getElementById('codeBlock');
    const btnGmail = document.getElementById('btnGmail');
    const btnSource = document.getElementById('btnSource');

    // Transformation Toggles
    const toggleRdns = document.getElementById('toggleRdns');
    const toggleRpath = document.getElementById('toggleRpath');
    const toggleEid = document.getElementById('toggleEid');
    const toggleIp = document.getElementById('toggleIp');
    const toggleHead = document.getElementById('toggleHead');

    // Status elements
    const statusElements = {
      fromName: document.getElementById('fromNameStatus'),
      rdns: document.getElementById('rdnsStatus'),
      rpath: document.getElementById('rpathStatus'),
      eid: document.getElementById('eidStatus'),
      ip: document.getElementById('ipStatus'),
      head: document.getElementById('headStatus'),
      insert: document.getElementById('insertStatus'),
      subject: document.getElementById('subjectStatus')
    };

    // History elements (and others)
    const darkModeToggle = document.getElementById('darkModeToggle');
    const historyToggle = document.getElementById('historyToggle');
    const historyPanel = document.getElementById('historyPanel');
    const closeHistoryBtn = document.getElementById('closeHistory');
    const historyItemsContainer = document.getElementById('historyItems');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const historyCategories = document.querySelectorAll('.history-category');

    // Extraction elements
    const inputText = document.getElementById('inputText');
    const extractionOutputText = document.getElementById('extractionOutputText');
    const associateIPsCheckbox = document.getElementById('associateIPs');
    const extractIPs = document.getElementById('extractIPs');
    const extractServers = document.getElementById('extractServers');
    const extractDomains = document.getElementById('extractDomains');
    const associationFilterContainer = document.getElementById('associationFilterContainer');
    const associationFilterInput = document.getElementById('associationFilter');
    const resultsInfo = document.getElementById('resultsInfo');
    const copyExtractionBtn = document.getElementById('copyExtractionBtn');
    const clearExtractionBtn = document.getElementById('clearExtractionBtn');

    // Encoder/Decoder elements
    const encodeInput = document.getElementById('encodeInput');
    const encodeOutput = document.getElementById('encodeOutput');
    const encodeBtn = document.getElementById('encodeBtn');
    const decodeBtn = document.getElementById('decodeBtn');
    const clearEncodeBtn = document.getElementById('clearEncodeBtn');
    const copyEncodeBtn = document.getElementById('copyEncodeBtn');
    const swapEncodeBtn = document.getElementById('swapEncodeBtn');
    const encodingTypeRadios = document.querySelectorAll('input[name="encodingType"]');


    // --------------------------------------------------------------------------------
    // Core Email Processing Logic
    // --------------------------------------------------------------------------------

    let currentHeaders = [];
    let selectedOptionalParams = new Set();
    let history = JSON.parse(localStorage.getItem('emailSuiteHistory')) || [];

    // Helper to escape HTML for display in source view
    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Function to update the preview frame content
    function updatePreview(content) {
      const isHtml = content.includes('<html') || content.includes('<body');

      // If we are in Source View mode, display the content directly
      if (sourceView.style.display !== 'none') {
        // Line number display
        const escapedContent = escapeHtml(content);
        const lines = escapedContent.split('\n');
        codeBlock.innerHTML = '';
        lines.forEach(line => {
          const span = document.createElement('span');
          span.textContent = line;
          codeBlock.appendChild(span);
        });
      }

      // Always update the iframe for Gmail View
      if (isHtml) {
        // Content is an HTML document
        const iframeDoc = gmailFrame.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(content);
        iframeDoc.close();
      } else {
        // Content is not a full HTML document (likely just headers/text)
        const iframeDoc = gmailFrame.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`<html><body><pre style="white-space: pre-wrap; word-wrap: break-word; font-family: sans-serif; padding: 15px;">${escapeHtml(content)}</pre></body></html>`);
        iframeDoc.close();
      }
    }

    /**
     * Applies the user's defined transformations to a single email's content.
     * @param {string} emailContent - The content of a single email after initial preparation (Custom Name/Subject).
     * @returns {string} The transformed email content.
     */
     function applySingleEmailTransformations(emailContent) {
        let modifiedContent = emailContent;
        const isRdnsChecked = toggleRdns.checked;
        const isRpathChecked = toggleRpath.checked;
        const isEidChecked = toggleEid.checked;
        const isIpChecked = toggleIp.checked;
        const isHeadChecked = toggleHead.checked;
        const insertText = insertTextarea.value.trim();

        // 1. [RDNS] & [P_RPATH] in From Name (replace domain after @)
        if (isRdnsChecked || isRpathChecked) {
            // Regex: (^From:\s*.*?<*[^@\s<]+) \@ ([^@>\s]+) (.*)
            const fromRegex = /(^From:\s*.*?<*[^@\s<]+)\@([^@>\s]+)(.*)/gim; // Only targets 'From:'

            let replacementString = '';
            if (isRdnsChecked) replacementString += '[RDNS]';
            if (isRpathChecked) replacementString += '[P_RPATH]';

            if (replacementString) {
                 modifiedContent = modifiedContent.replace(fromRegex, (match, p1, p2, p3) => {
                    return p1 + '@' + replacementString + p3;
                });
            }
        }

        // 2. [eid] in Message-ID (before @)
        if (isEidChecked) {
            const messageIdRegex = /(Message-ID:\s*<)([^@]+)(\@.*?>)/im;
            modifiedContent = modifiedContent.replace(messageIdRegex, (match, p1, p2, p3) => {
                return p1 + p2 + '[eid]' + p3;
            });
        }

        // 3. Separate headers from body
        const headerBodySplitRegex = /^([\s\S]*?)(\r?\n\r?\n)([\s\S]*)$/;
        const match = modifiedContent.match(headerBodySplitRegex);

        if (match) {
            let headers = match[1];
            let separator = match[2]; // The double newline
            let body = match[3];

            // --- Apply Body Transformations ---

            // 4. Custom HTML Insert (Insert Textarea)
            if (insertText) {
                const headTagRegex = /(<head[^>]*>)/i;
                if (headTagRegex.test(body)) {
                    body = body.replace(headTagRegex, `$1\n${insertText}\n`);
                } else {
                    body = insertText + '\n' + body;
                }
            }

            // 5. <head><select> insertion
            if (isHeadChecked) {
                const headTagForSelect = /<head>/i;
                 if (headTagForSelect.test(body) && !body.match(/<head>\s*<select/i)) {
                     body = body.replace(headTagForSelect, '<head><select style="display:none"></select>');
                 } else if (!headTagForSelect.test(body)) {
                     body = '<head><select style="display:none"></select></head>\n' + body;
                 }
            }

            // 6. [ip] Insertion (Body) - *** UPDATED PRIORITY ***
            if (isIpChecked) {
                let ipPlaceholder = '[ip]';
                let inserted = false; 

                // Priority 1: <!DOCTYPE
                if (body.match(/<!DOCTYPE/i)) {
                    body = body.replace(/(<!DOCTYPE)/i, ipPlaceholder + '\n' + '$1');
                    inserted = true;
                }
                // Priority 2: <html...> (NEW)
                if (!inserted && body.match(/<html/i)) {
                    body = body.replace(/(<html)/i, ipPlaceholder + '\n' + '$1');
                    inserted = true;
                }
                // Priority 3: <img...>
                if (!inserted && body.match(/<img/i)) {
                    body = body.replace(/(<img)/i, ipPlaceholder + '\n' + '$1');
                    inserted = true;
                }
                // Priority 4: <body...>
                if (!inserted && body.match(/<body/i)) {
                    body = body.replace(/(<body)/i, ipPlaceholder + '\n' + '$1');
                    inserted = true;
                }
                // Priority 5: Prepend to body if none found
                if (!inserted) {
                    body = ipPlaceholder + '\n' + body;
                }
            }

            modifiedContent = headers + separator + body;
        } else {
             console.warn("Could not reliably detect header/body split. Body transformations might not apply.");
        }

        return modifiedContent;
    }


    // Main processing function (handles cleaning, optional transformations, and batching)
    function processInput() {
      let content = input.value;
      if (!content.trim()) {
        output.value = '';
        updatePreview('');
        currentHeaders = [];
        buildHeaderCheckboxes();
        return;
      }

      // 1. Separate all emails using the delimiter
      const emails = content.split(new RegExp(EMAIL_DELIMITER, 'gi'));

      const cleanedEmails = emails.map((email, index) => {
        email = email.trim();
        if (!email) return '';

        // Extract headers (first part until the first blank line) and body
        const headerEndIndex = email.indexOf('\n\n');
        let header = '';
        let body = email;

        if (headerEndIndex !== -1) {
          header = email.substring(0, headerEndIndex);
          body = email.substring(headerEndIndex + 2);
        }

        // --- Store original header for UI checkbox generation ---
        let originalHeaderForUI = header;

        // --- Transformation Preparation (Applied before cleaning) ---
        let currentHeader = header;

        // a. Apply Custom From Name (Modifies existing line)
        const customName = customNameInput.value.trim();
        if (customName) {
          currentHeader = currentHeader.replace(/^(From:.*<)/im, `From: ${customName} <`);
        }

        // b. Apply Custom Subject (Modifies existing line)
        const customSubject = customSubjectInput.value.trim();
        if (customSubject) {
          currentHeader = currentHeader.replace(/^(Subject:.*)/im, `Subject: ${customSubject}`);
        }

        // Temporarily join the header and body for complex, in-line transformations
        let tempEmail = currentHeader + (currentHeader ? '\n\n' : '') + body;

        // c. Apply in-line transformations ([RDNS], [P_RPATH], [eid], [ip], <head><select>, custom HTML insert)
        const transformedEmail = applySingleEmailTransformations(tempEmail);

        // Split back into headers and body
        const transformedParts = transformedEmail.match(/^([\s\S]*?)(\r?\n\r?\n)([\s\S]*)$/);
        let transformedHeader = transformedEmail;
        let transformedBody = '';

        if (transformedParts) {
            transformedHeader = transformedParts[1];
            transformedBody = transformedParts[3];
        }


        // --- Header Cleaning ---
        const paramsToRemove = new Set([...FIXED_SELECTED_PARAMS, ...Array.from(selectedOptionalParams)]);

        const headerLines = transformedHeader.split('\n');
        const cleanedHeaderLines = headerLines.filter(line => {
          const headerKey = line.split(':')[0].trim();
          // Keep the line if its key is NOT in the paramsToRemove set.
          return !paramsToRemove.has(headerKey);
        });

        // Reconstruct the cleaned header
        const cleanedHeader = cleanedHeaderLines.join('\n').trim();

        // Reconstruct the final email
        const finalEmail = cleanedHeader + (cleanedHeader ? '\n\n' : '') + transformedBody;

        // For the first email in the batch, update the headers list for the UI
        if (index === 0) {
          // Base the UI list on the ORIGINAL header before cleaning/transformation markers
          currentHeaders = originalHeaderForUI.split('\n')
            .map(line => line.split(':')[0].trim())
            .filter(key => key && key.length > 1) // Filter out empty strings or single characters
            .filter((value, idx, self) => self.indexOf(value) === idx); // Unique headers
          buildHeaderCheckboxes();
        }

        return finalEmail;
      }).filter(e => e).join(`\n\n${EMAIL_DELIMITER}\n\n`); // Join cleaned emails with delimiter

      output.value = cleanedEmails;
      updatePreview(emails[0] || ''); // Preview only the first email of the original batch for consistency

      // Update status indicators
      Object.keys(statusElements).forEach(key => {
        statusElements[key].style.display = 'none';
      });
    }

    // Function to build the header checkboxes dynamically
    function buildHeaderCheckboxes() {
      headersBox.innerHTML = '';

      if (currentHeaders.length === 0) {
        headersBox.innerHTML = '<p style="color:var(--muted)"> Paste or Import a header to see available fields...</p>';
        return;
      }

      const optionalHeaders = currentHeaders.filter(header => !FIXED_SELECTED_PARAMS.includes(header));
      const fixedHeaders = currentHeaders.filter(header => FIXED_SELECTED_PARAMS.includes(header));

      // Display Fixed Headers first
      if (fixedHeaders.length > 0) {
        const fixedGroup = document.createElement('div');
        fixedGroup.innerHTML = '<label style="margin-top:0;">Fixed Headers (Always Removed):</label>';
        fixedHeaders.forEach(header => {
          const div = document.createElement('div');
          div.className = 'header-checkbox fixed-selected';
          div.innerHTML = `
            <input type="checkbox" id="header-${header}" value="${header}" checked disabled>
            <label for="header-${header}">${header}</label>
          `;
          fixedGroup.appendChild(div);
        });
        headersBox.appendChild(fixedGroup);
      }

      // Display Optional Headers
      if (optionalHeaders.length > 0) {
        const optionalGroup = document.createElement('div');
        optionalGroup.innerHTML = '<label style="margin-top:15px;">Optional Headers (Toggle to Remove):</label>';
        optionalHeaders.forEach(header => {
          const div = document.createElement('div');
          div.className = 'header-checkbox optional';
          div.innerHTML = `
            <input type="checkbox" id="header-${header}" value="${header}" ${selectedOptionalParams.has(header) ? 'checked' : ''}>
            <label for="header-${header}">${header}</label>
          `;
          optionalGroup.appendChild(div);
        });
        headersBox.appendChild(optionalGroup);
      }

      // Add event listeners to optional checkboxes
      headersBox.querySelectorAll('.header-checkbox.optional input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedOptionalParams.add(e.target.value);
          } else {
            selectedOptionalParams.delete(e.target.value);
          }
          if (liveToggle.checked) {
            processInput();
          }
        });
      });
    }

    // --------------------------------------------------------------------------------
    // Event Handlers for Cleaner Tab
    // --------------------------------------------------------------------------------

    input.addEventListener('input', () => {
      if (liveToggle.checked) {
        processInput();
      }
      // Re-extract headers on any input to update checkboxes
      if (!input.value.trim()) {
        currentHeaders = [];
        buildHeaderCheckboxes();
      } else if (currentHeaders.length === 0 || !liveToggle.checked) {
        // Only run a quick header extraction without full processing if Live is off
        const email = input.value.split(new RegExp(EMAIL_DELIMITER, 'gi'))[0];
        const header = email.substring(0, email.indexOf('\n\n') > -1 ? email.indexOf('\n\n') : email.length);
        currentHeaders = header.split('\n')
            .map(line => line.split(':')[0].trim())
            .filter(key => key && key.length > 1)
            .filter((value, idx, self) => self.indexOf(value) === idx);
        buildHeaderCheckboxes();
      }
    });

    cleanBtn.addEventListener('click', () => {
      processInput();
      if (output.value.trim()) {
        addToHistory('Cleaned Content', output.value.trim(), 'cleaned');
      }
    });

    applyBtn.addEventListener('click', () => {
      processInput();
      // Show transformation status
      if (toggleRdns.checked) statusElements.rdns.style.display = 'block';
      if (toggleRpath.checked) statusElements.rpath.style.display = 'block';
      if (toggleEid.checked) statusElements.eid.style.display = 'block';
      if (toggleIp.checked) statusElements.ip.style.display = 'block';
      if (toggleHead.checked) statusElements.head.style.display = 'block';
      if (output.value.trim()) {
        addToHistory('Applied Transformations', output.value.trim(), 'cleaned');
      }
    });

    applyCustomNameBtn.addEventListener('click', () => {
        processInput();
        if (customNameInput.value.trim()) {
            statusElements.fromName.style.display = 'block';
        }
    });

    subjectBtn.addEventListener('click', () => {
        processInput();
        if (customSubjectInput.value.trim()) {
            statusElements.subject.style.display = 'block';
            addToHistory('Applied Custom Subject', customSubjectInput.value.trim(), 'subject');
        }
    });

    insertBtn.addEventListener('click', () => {
        processInput();
        if (insertTextarea.value.trim()) {
            statusElements.insert.style.display = 'block';
            addToHistory('Inserted HTML Snippet', insertTextarea.value.trim(), 'htmlInsert');
        }
    });

    // Import Button Logic (Handles single or multiple files)
    importBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
      const files = event.target.files;
      if (files.length === 0) return;

      let fileContents = [];
      let filesProcessed = 0;

      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();
        reader.onload = (e) => {
          fileContents[i] = e.target.result;
          filesProcessed++;

          if (filesProcessed === files.length) {
            // All files processed. Join content with the delimiter.
            input.value = fileContents.join(`\n\n${EMAIL_DELIMITER}\n\n`);
            // Reset file input value to allow the same file(s) to be selected again
            fileInput.value = '';
            processInput();
          }
        };
        reader.onerror = () => {
          console.error(`Error reading file: ${files[i].name}`);
          filesProcessed++;
        };
        reader.readAsText(files[i]);
      }
    });

    // Export Button Logic for individual files
    exportBtn.addEventListener('click', () => {
        const content = output.value.trim();
        if (!content) {
            alert("Nothing to export. Clean an email first.");
            return;
        }

        // Split cleaned content by the delimiter to get individual emails
        const emails = content.split(new RegExp(`\\n\\n${EMAIL_DELIMITER}\\n\\n`, 'g')).filter(e => e.trim());

        if (emails.length === 0) {
            alert("No complete emails found to export after cleaning.");
            return;
        }

        // Determine the base filename, removing any .txt extension if present
        const baseFilename = exportFilenameInput.value.trim().replace(/\.txt$/, '') || 'cleaned_email';

        // Iterate through emails and trigger a download for each
        emails.forEach((email, index) => {
            // Construct filename with an index
            const filename = `${baseFilename}_${index + 1}.txt`;
            const blob = new Blob([email], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            // Create and click a temporary link element to trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // Clean up the temporary URL and element
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        addToHistory('Exported Batch', `${emails.length} individual emails exported.`, 'export');
    });

    // Clear Button Logic
    clearBtn.addEventListener('click', () => {
      input.value = '';
      output.value = '';
      currentHeaders = [];
      selectedOptionalParams.clear();
      buildHeaderCheckboxes();
      updatePreview('');
      Object.keys(statusElements).forEach(key => {
        statusElements[key].style.display = 'none';
      });
      // Clear transformation checkboxes
      toggleRdns.checked = false;
      toggleRpath.checked = false;
      toggleEid.checked = false;
      toggleIp.checked = false;
      toggleHead.checked = false;
      customNameInput.value = '';
      customSubjectInput.value = '';
      insertTextarea.value = '';
    });

    // Deselect Optional Button
    deselectBtn.addEventListener('click', () => {
        selectedOptionalParams.clear();
        buildHeaderCheckboxes();
        if (liveToggle.checked) {
            processInput();
        }
    });

    // Live Update Toggle for Transformations
    document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            if (liveToggle.checked && checkbox.id !== 'liveToggle') {
                processInput();
            }
        });
    });

    // Live Update for subject and name
    customNameInput.addEventListener('input', () => {
        if (liveToggle.checked) {
            processInput();
        }
    });
    customSubjectInput.addEventListener('input', () => {
        if (liveToggle.checked) {
            processInput();
        }
    });
    insertTextarea.addEventListener('input', () => {
        if (liveToggle.checked) {
            processInput();
        }
    });

    // --------------------------------------------------------------------------------
    // Preview Viewer Logic
    // --------------------------------------------------------------------------------

    btnGmail.addEventListener('click', () => {
      btnGmail.classList.add('active');
      btnSource.classList.remove('active');
      gmailPreview.style.display = 'block';
      sourceView.style.display = 'none';
      updatePreview(input.value); // Refresh the preview frame
    });

    btnSource.addEventListener('click', () => {
      btnSource.classList.add('active');
      btnGmail.classList.remove('active');
      sourceView.style.display = 'block';
      gmailPreview.style.display = 'none';
      updatePreview(input.value); // Refresh the code view
    });

    // --------------------------------------------------------------------------------
    // Encoder/Decoder Logic
    // --------------------------------------------------------------------------------

    function encodeText(text, type) {
        if (!text) return '';
        switch (type) {
            case 'base64':
                return btoa(text);
            case 'url':
                return encodeURIComponent(text);
            case 'html':
                return escapeHtml(text).replace(/ /g, '&#32;');
            case 'hex':
                return Array.from(text).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');
            case 'quoted-printable':
                // Simple implementation: replace non-ASCII characters and = with =XX
                return text.replace(/[\x80-\xff]/g, c => '=' + c.charCodeAt(0).toString(16).toUpperCase())
                           .replace(/=/g, '=3D')
                           .replace(/\s+$/gm, '='); // Soft line break for spaces at line end (basic QP)
            default:
                return text;
        }
    }

    function decodeText(text, type) {
        if (!text) return '';
        try {
            switch (type) {
                case 'base64':
                    return atob(text);
                case 'url':
                    return decodeURIComponent(text);
                case 'html':
                    const parser = new DOMParser();
                    const dom = parser.parseFromString(`<!doctype html><body>${text}`, 'text/html');
                    return dom.body.textContent;
                case 'hex':
                    return text.match(/.{1,2}/g).map(byte => String.fromCharCode(parseInt(byte, 16))).join('');
                case 'quoted-printable':
                    // Simple implementation: remove soft breaks, decode =XX, replace =3D
                    return text.replace(/=\r?\n/g, '') // Remove soft line breaks
                               .replace(/=([a-fA-F0-9]{2})/g, (match, hex) => String.fromCharCode(parseInt(hex, 16)))
                               .replace(/=3D/g, '='); // Decode =3D back to =
                default:
                    return text;
            }
        } catch (e) {
            return 'Error decoding: ' + e.message;
        }
    }

    encodeBtn.addEventListener('click', () => {
        const text = encodeInput.value;
        const type = document.querySelector('input[name="encodingType"]:checked').value;
        encodeOutput.value = encodeText(text, type);
    });

    decodeBtn.addEventListener('click', () => {
        const text = encodeInput.value;
        const type = document.querySelector('input[name="encodingType"]:checked').value;
        encodeOutput.value = decodeText(text, type);
    });

    clearEncodeBtn.addEventListener('click', () => {
        encodeInput.value = '';
        encodeOutput.value = '';
    });

    copyEncodeBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(encodeOutput.value).then(() => {
            // Flash a copied message
            const originalText = copyEncodeBtn.textContent;
            copyEncodeBtn.textContent = 'Copied!';
            setTimeout(() => { copyEncodeBtn.textContent = originalText; }, 2000);
        });
    });

    swapEncodeBtn.addEventListener('click', () => {
        const inputVal = encodeInput.value;
        const outputVal = encodeOutput.value;
        encodeInput.value = outputVal;
        encodeOutput.value = inputVal;
    });

    // --------------------------------------------------------------------------------
    // Extraction Tool Logic
    // --------------------------------------------------------------------------------

    function performExtraction() {
        const text = inputText.value;
        if (!text) {
            extractionOutputText.textContent = '';
            resultsInfo.textContent = 'No results yet. Start typing or paste text to see extracted items.';
            return;
        }

        const shouldAssociate = associateIPsCheckbox.checked;
        const shouldExtractIPs = extractIPs.checked;
        const shouldExtractServers = extractServers.checked;
        const shouldExtractDomains = extractDomains.checked;
        const filterKeyword = associationFilterInput.value.trim().toLowerCase();

        // 1. Separate by blank lines (assuming a blank line separates "email snippets" for association)
        const snippets = text.split(/\n\s*\n/g).filter(s => s.trim());
        let results = [];
        let totalCount = 0;

        snippets.forEach(snippet => {
            const lines = snippet.trim().split('\n').map(l => l.trim()).filter(l => l);

            // Determine the "Context" (Sender/Subject) for association
            let context = '';
            if (shouldAssociate) {
                // Assuming Sender is first line, Subject is second
                const sender = lines[0] || 'Unknown Sender';
                const subject = lines.length > 1 ? lines[1] : 'Unknown Subject';
                context = `[Sender/Subject: ${sender} / ${subject}]`;

                if (filterKeyword && !context.toLowerCase().includes(filterKeyword)) {
                    return; // Skip this snippet if it doesn't match the filter
                }
            }

            // Extract IPs
            if (shouldExtractIPs) {
                const ipRegex = /\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g;
                let match;
                while ((match = ipRegex.exec(snippet)) !== null) {
                    if (match[0] !== '0.0.0.0' && match[0] !== '127.0.0.1') {
                         results.push(`IP: ${match[0]} ${context}`);
                         totalCount++;
                    }
                }
            }

            // Extract Servers (simple hostnames/FQDNs)
            if (shouldExtractServers) {
                // Matches hostnames like mail.example.com or mx1.sub.domain.com
                const serverRegex = /\b[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)*\.[a-z]{2,}\b/gi;
                let match;
                const extractedServers = new Set();
                while ((match = serverRegex.exec(snippet)) !== null) {
                    const server = match[0].toLowerCase();
                    if (!server.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)) { // Exclude IPs
                        if (!extractedServers.has(server)) {
                           extractedServers.add(server);
                           results.push(`Server: ${server} ${context}`);
                           totalCount++;
                        }
                    }
                }
            }

            // Extract Domains (Top-level domains and second-level)
            if (shouldExtractDomains) {
                // Matches domains in URL or email formats (e.g., example.com, sub.example.co.uk)
                const domainRegex = /@([a-z0-9\-\.]+\.[a-z]{2,})|https?:\/\/(?:www\.)?([a-z0-9\-\.]+\.[a-z]{2,})/gi;
                let match;
                const extractedDomains = new Set();
                while ((match = domainRegex.exec(snippet)) !== null) {
                    const domain = (match[1] || match[2]).toLowerCase();
                    if (domain && !extractedDomains.has(domain)) {
                        extractedDomains.add(domain);
                        results.push(`Domain: ${domain} ${context}`);
                        totalCount++;
                    }
                }
            }
        });

        const uniqueResults = [...new Set(results)].join('\n');

        extractionOutputText.textContent = uniqueResults || 'No items extracted based on current options/filter.';
        resultsInfo.textContent = `Found ${totalCount} total items. Displaying ${new Set(results).size} unique results.`;
    }

    // Extraction Event Handlers (Live update)
    inputText.addEventListener('input', performExtraction);
    associateIPsCheckbox.addEventListener('change', () => {
        associationFilterContainer.style.display = associateIPsCheckbox.checked ? 'block' : 'none';
        performExtraction();
    });
    associationFilterInput.addEventListener('input', performExtraction);
    extractIPs.addEventListener('change', performExtraction);
    extractServers.addEventListener('change', performExtraction);
    extractDomains.addEventListener('change', performExtraction);

    copyExtractionBtn.addEventListener('click', () => {
        const text = extractionOutputText.textContent;
        if (text && !text.startsWith('No items')) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = copyExtractionBtn.textContent;
                copyExtractionBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyExtractionBtn.textContent = originalText;
                }, 2000);
            });
        }
    });

    clearExtractionBtn.addEventListener('click', () => {
        inputText.value = '';
        associationFilterInput.value = '';
        performExtraction();
    });

V
    // --------------------------------------------------------------------------------
    // History & Dark Mode Logic
    // --------------------------------------------------------------------------------

    function addToHistory(title, content, category) {
        const timestamp = new Date().toLocaleString();
        history.unshift({ title, content, category, timestamp });
        if (history.length > 50) { // Keep history manageable
            history.pop();
        }
        localStorage.setItem('emailSuiteHistory', JSON.stringify(history));
        renderHistory();
    }

    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');

        // Deactivate all tabs and hide all content
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => {
          c.classList.remove('active');
          c.classList.remove('show');
        });

        // Activate the clicked tab and show content with animation
        tab.classList.add('active');
        const activeContent = document.getElementById(tabId);
        if (activeContent) {
          activeContent.classList.add('active');
          // Use setTimeout for the transition effect
          setTimeout(() => activeContent.classList.add('show'), 10);
        }
      });
    });


    function renderHistory(filter = 'all') {
        historyItemsContainer.innerHTML = '';
        const filteredHistory = history.filter(item => filter === 'all' || item.category === filter);

        if (filteredHistory.length === 0) {
            historyItemsContainer.innerHTML = `<div class="no-history">No history items found for '${filter}'.</div>`;
            return;
        }

        filteredHistory.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.setAttribute('data-category', item.category);
            div.title = item.title;
            div.innerHTML = `
                <div class="history-title">${item.title}</div>
                <div class="history-content">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</div>
                <div class="history-timestamp">${item.timestamp}</div>
            `;

            // Add a click listener to populate the relevant input box
            div.addEventListener('click', () => {
                if (item.category === 'cleaned') {
                    input.value = item.content;
                    historyPanel.classList.remove('active');
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active', 'show'));
                    document.getElementById('email-cleaner').classList.add('active', 'show');
                    document.querySelector('[data-tab="email-cleaner"]').classList.add('active');
                    processInput();
                } else if (item.category === 'htmlInsert') {
                    insertTextarea.value = item.content;
                } else if (item.category === 'subject') {
                    customSubjectInput.value = item.content;
                }
            });

            historyItemsContainer.appendChild(div);
        });
    }

    historyCategories.forEach(cat => {
        cat.addEventListener('click', () => {
            historyCategories.forEach(c => c.classList.remove('active'));
            cat.classList.add('active');
            renderHistory(cat.getAttribute('data-category'));
        });
    });

    historyToggle.addEventListener('click', () => {
        historyPanel.classList.add('active');
        renderHistory();
    });

    closeHistoryBtn.addEventListener('click', () => {
        historyPanel.classList.remove('active');
    });

    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear ALL history? This cannot be undone.')) {
            history = [];
            localStorage.removeItem('emailSuiteHistory');
            renderHistory();
        }
    });

    // Dark Mode Toggle Logic
    const currentMode = localStorage.getItem('darkMode') === 'true';
    if (currentMode) {
      document.body.classList.add('dark-mode');
      darkModeToggle.classList.add('active');
    }

    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      darkModeToggle.classList.toggle('active');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
    });

    // Add loading animation to buttons
    document.querySelectorAll('.btn').forEach(btn => {
        if (!btn.id.includes('history') && !btn.id.includes('closeHistory')) {
            btn.addEventListener('click', function() {
                this.classList.add('loading');
                setTimeout(() => {
                    this.classList.remove('loading');
                }, 800);
            });
        }
    });

    // Initialize the app
    window.addEventListener('load', () => {
        // Initial build based on the default input or cleared state
        buildHeaderCheckboxes();
        // Since input is not empty by default for extraction, run it on load
        performExtraction();
    });
  </script>
</body>
</html>
